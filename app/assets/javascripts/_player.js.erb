$(document).ready(function(){
  var musicPlayers = $('.mp')

  $(musicPlayers).each(function(i,musicPlayer){
    var mpAudio = $('.mp-audio', musicPlayer)[0],
        mpWaveform = $('#mp-waveform', musicPlayer)[0],
        mpPlayhead = $('.mp-visualizer-playhead', musicPlayer)[0],
        mpPlay = $('.mp-controls-play', musicPlayer)[0],
        mpRegion = $('wavesurfer-region', musicPlayer)[0],
        mpRestart = $('.mp-controls-restart', musicPlayer)[0],
        mpReplay = $('.mp-controls-replay', musicPlayer)[0],
        mpLoop = $('.mp-controls-loop', musicPlayer)[0],
        mpTimeline = $('#mp-timeline', musicPlayer)[0]

    var waveSurfer = WaveSurfer.create({
        container: mpWaveform,
        cursorColor: '#333',
        progressColor: '#00ff99',
        waveColor: '#666',
        barWidth: 3,
        skipLength: 10,
        height: 100,
        autoCenter: true
    })

    waveSurfer.load(mpAudio.src)

    waveSurfer.on('ready', function (){
      var timeline = Object.create(WaveSurfer.Timeline);
      timeline.init({
        wavesurfer: waveSurfer,
        container: mpTimeline
      })

      // Add a couple of pre-defined regions
      var region = waveSurfer.addRegion({
        start: 0, // time in seconds
        end: 20, // time in seconds
        color: 'rgba(0, 0, 0, 0.4)'
      })
    })

    // Playing & Pausing
    mpPlay.addEventListener('click', function(){
      if (waveSurfer.isPlaying()) {
        mpPlay.innerHTML = '<i class="fi-play"></i>'
        waveSurfer.pause()
      }
      else {
        mpPlay.innerHTML = '<i class="fi-pause"></i>'
        waveSurfer.play()
      }
    })

    // Restarting
    mpRestart.addEventListener('click', function(){
      waveSurfer.seekTo(0)
    })

    // 10-Second Rewind
    mpReplay.addEventListener('click', function(){
      waveSurfer.skipBackward()
    })

    // Looping
    mpLoop.addEventListener('click', function(){
      region.loop = true
      waveSurfer.seekTo(region.start)
    })
  })
})
